<!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="mongodb,">










<meta name="description" content="1. 为什么用MongoDB？假如我们要位每篇文章添加评论功能，会发现每篇文章可能要多篇评论，而且这个数目是动态变化的，而且每篇评论还包括好几项内容：评论的人、评论的时间、以及评论内容。这时候要将这些内容都塞进上述的那个表，就显得很困难。通常的做法是为评论(comment)单独建一个表：| ID | Author  | Time   | Content  | Article ||—-|:—–: |">
<meta name="keywords" content="mongodb">
<meta property="og:type" content="article">
<meta property="og:title" content="【转】mongodb极简入门">
<meta property="og:url" content="https://kingsea0-0.github.io/posts/12508/index.html">
<meta property="og:site_name" content="Kingsea's Blog">
<meta property="og:description" content="1. 为什么用MongoDB？假如我们要位每篇文章添加评论功能，会发现每篇文章可能要多篇评论，而且这个数目是动态变化的，而且每篇评论还包括好几项内容：评论的人、评论的时间、以及评论内容。这时候要将这些内容都塞进上述的那个表，就显得很困难。通常的做法是为评论(comment)单独建一个表：| ID | Author  | Time   | Content  | Article ||—-|:—–: |">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-12-07T12:21:53.747Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【转】mongodb极简入门">
<meta name="twitter:description" content="1. 为什么用MongoDB？假如我们要位每篇文章添加评论功能，会发现每篇文章可能要多篇评论，而且这个数目是动态变化的，而且每篇评论还包括好几项内容：评论的人、评论的时间、以及评论内容。这时候要将这些内容都塞进上述的那个表，就显得很困难。通常的做法是为评论(comment)单独建一个表：| ID | Author  | Time   | Content  | Article ||—-|:—–: |">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kingsea0-0.github.io/posts/12508/">





  <title>【转】mongodb极简入门 | Kingsea's Blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kingsea's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">data garbage producer</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kingsea0-0.github.io/posts/12508/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="King sea">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kingsea's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">【转】mongodb极简入门</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-30T11:06:00+08:00">
                2017-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <meta name="generator" content="Hexo 3.8.0"><h4>1. 为什么用MongoDB？</h4><br>假如我们要位每篇文章添加评论功能，会发现每篇文章可能要多篇评论，而且这个数目是动态变化的，而且每篇评论还包括好几项内容：评论的人、评论的时间、以及评论内容。这时候要将这些内容都塞进上述的那个表，就显得很困难。通常的做法是为评论(comment)单独建一个表：<br><br>| ID | Author  | Time   | Content  | Article |<br>|—-|:—–: |:—————–:|:——:|:——:|<br>| C_1  | Anna | 2014-12-26 08:23 | Really good articles! | A_1 |<br>| C_2  | David | 2014-12-25 09:30     | I like it! |  A_1 |<br><br>类似地，每篇文章可能会有若干标签(tags)。标签本身又是一个表单：<br><br>| ID | Category  | Tags   | Content  | Article |<br>|—-|:—–: |:—————–:|:——:|:——:|<br>| T_1  | Anna | 2014-12-26 08:23 | Really good articles!|  A_1 |<br>| T_2  | David | 2014-12-25 09:30     | I like it!| A_2 |<br><br>而博客的表格则要通过foreign key跟这些相关联的表格联系起来(可能还包括作者、出版社等其它表格)。这样一来，当我们做查询的时候，比如说，“找出评论数不少于3的标签为‘政治评论’的作者为Sam的文章”，就会涉及到复杂的跨表查询，需要大量使用<code>join</code>语句。这种跨表查询不仅降低了查询速度，而且这些语句写起来也不简单。<br><br>那么，如果用MongoDB数据库来实现，可以如何设计数据模型呢？很简单，像下面这样<a href="http://www.tutorialspoint.com/mongodb/mongodb_data_modeling.htm" target="_blank" rel="noopener">[1]</a>：<br><br><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">_id</span>: POST_ID</span><br><span class="line">  <span class="attribute">title</span>: TITLE_OF_POST,</span><br><span class="line">  <span class="attribute">description</span>: POST_DESCRIPTION,</span><br><span class="line">  <span class="attribute">author</span>: POST_BY,</span><br><span class="line">  <span class="attribute">tags</span>: [TAG1, TAG2, TAG3],</span><br><span class="line">  <span class="attribute">likes</span>: TOTAL_LIKES,</span><br><span class="line">  <span class="attribute">comments</span>: [</span><br><span class="line">     {</span><br><span class="line">        <span class="attribute">user</span>:<span class="string">'COMMENT_BY'</span>,</span><br><span class="line">        <span class="attribute">message</span>: TEXT,</span><br><span class="line">        <span class="attribute">dateCreated</span>: DATE_TIME,</span><br><span class="line">     },</span><br><span class="line">     {</span><br><span class="line">        <span class="attribute">user</span>:<span class="string">'COMMENT_BY'</span>,</span><br><span class="line">        <span class="attribute">message</span>: TEXT,</span><br><span class="line">        <span class="attribute">dateCreated</span>: DATE_TIME,</span><br><span class="line">     }</span><br><span class="line">  ]</span><br></pre></td></tr></tbody></table></figure><br><br>在MongoDB里，每篇博客文章以一个文档(document)的形式保存起来，而文档内部包含了很多项目，比如<code>title tags</code>等，每一个项目都是<code>key-value</code>的形式，即有一个项目的名字，比如<code>title</code>，以及它的值<code>TITLE_OF_POST</code>。而重要的是，一个<code>key</code>可以有多个<code>values</code>，他们用<code>[]</code>括起来。<br><br>这种“宽松”的数据存储形式非常灵活，MongoDB不限制每个<code>key</code>对应的<code>values</code>的数目。比如有的文章没有评论，则它的值就是一个空集，完全没有问题；有的文章评论很多，也可以无限制地插入。更灵活的是，MongoDB不要求同一个集合(collection，相当于SQL的table)里面的不同document有相同的key，比如除了上述这种文档组织，有的文档所代表的文章可能没有likes这个项目，再比如有的文章可能有更多的项目，比如可能还有dislikes等等。这些不同的文档都可以灵活地存储在同一个集合下，而且查询起来也异常简单，因为都在一个文档里，不用进行各种跨文档查询。而这种MongoDB式的存储也方便了数据的维护，对于一篇博客文章来说，所有的相关数据都在这个document里面，不用去考虑一个数据操作需要involve多少个表格。<br><br>当然，除了上述的优点，MongoDB还有不少别的优势，比如MongoDB的数据是用JSON(Javascript Object Notation)存储的(就是上面的这种key-value的形式)，而几乎所有的web应用都是基于Javascript的。因此，存储的数据和应用的数据的格式是高度一致的，不需经过转换。更多的优点可以查看：<a href="http://www.tutorialspoint.com/mongodb/mongodb_advantages.htm" target="_blank" rel="noopener">[2]</a>。<br><br><h4>2. 关于这篇文章</h4>

<p>这个极简教程，或者说笔记，并不是一个覆盖MongoDB方方面面的教程。所谓极简的意思，就是只选取那些最重要、最常用的内容进行基于实例的介绍，从而让读者能够在最短的时间内快速上手，并且能顺利地进行后续的纵深的学习。</p>
<p>具体地说，这个教程的特点是：</p>
<ul><br><li>不求全面，只求实用。只覆盖最核心的部分；</li><br><li>以大量例子为导向；</li><br><li>一边阅读一边动手操作的话，大约只需要2小时的时间；</li><br></ul>

<p>阅读这篇文章不需要有特别的基础，但最好知道数据库的基本概念，如果本身熟悉SQL那就更好啦。</p>
<h4>3. 安装与环境</h4>

<p>MongoDB可以在Windows、Linux、Mac OS X等主流平台运行，而且下载和安装非常简单，非常友好。这篇文档的例子采用MongoDB 2.6版本，均在OS X测试过，有充足的理由相信，在其它平台也能顺利运行。</p>
<p>Windows的安装和设置可以参考：<a href="http://www.w3cschool.cc/mongodb/mongodb-window-install.html；" target="_blank" rel="noopener">http://www.w3cschool.cc/mongodb/mongodb-window-install.html；</a></p>
<p>Linux的安装和设置可以参考：<a href="http://www.w3cschool.cc/mongodb/mongodb-linux-install.html；" target="_blank" rel="noopener">http://www.w3cschool.cc/mongodb/mongodb-linux-install.html；</a></p>
<p>Mac OS X下的安装和设置：</p>
<ul><br><li>1. 在<a href="https://www.mongodb.org/" target="_blank" rel="noopener">https://www.mongodb.org/</a> 下载适合你的Mac的MongoDb;</li><br><li>2. 下载得到的文件是一个zip文件，解压，然后放到你想到的文件夹，比如/Users/Steven/MongoDB;</li><br><li>3. 创建一个你喜欢的文件夹来存储你的数据，比如/User/Steven/myData;</li><br><li>4. 打开Terminal，cd到2里面那个文件夹/Users/Steven/MongoDB，再cd bin;</li><br><li>5. 输入./mongod –dbpath /User/Steven/myData,等到出现类似“waiting for connections on port 27017”，说明MongoDB服务器已架设好，而数据将储存在myData里面；</li><br><li>6. 新打开一个Terminal, cd /Users/Steven/MongoDB/bin,然后运行./mongo;顺利的话它将出现一个interactive shell让你进行各种操作，而你的数据将储存在myData里</li><br></ul>

<p>如果以上的各个步骤都运行顺利，就可以跳到下一节啦。</p>
<h4>4. 创建集合和删除集合</h4><br>在上一节执行完步骤6后，你会看到命令行里显示：<code>connecting to: test</code>，这里的<code>test</code>是默认的数据库。这里我们可以新建一个数据库。在命令行里打入：<br><br><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">tutorial</span></span><br></pre></td></tr></tbody></table></figure><br><br>这样就新建了一个叫做<code>tutorial</code>的数据库。你可以执行<br><br><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span></span><br></pre></td></tr></tbody></table></figure><br><br>来显示当前的数据库。不过这时候由于我们的新数据库是空的，所以会显示类似这样的：<br><br><figure class="highlight lisp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin  (<span class="name">empty</span>)</span><br><span class="line">local  <span class="number">0.078</span>GB</span><br></pre></td></tr></tbody></table></figure><br><br>我们试着往我们的数据库里添加一个集合(collection)，MongoDB里的集合和SQL里面的表格是类似的：<br><br><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.createCollection</span>(<span class="string">'author'</span>)</span><br></pre></td></tr></tbody></table></figure><br><br>顺利的话会显示：<br><br><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="attr">"ok"</span> : <span class="number">1</span> }</span><br></pre></td></tr></tbody></table></figure><br><br>表示创建成功。<br><br>你可以再回头执行：<br><br><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span></span><br></pre></td></tr></tbody></table></figure><br><br>这时候我们的tutorial集合已经位列其中。你可以再执行<br><br><figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">show collections</span></span><br></pre></td></tr></tbody></table></figure><br><br>可以看到创建的集合author也在其中。<br><br>我们暂时不需要author这个集合，所以我们可以通过执行：<br><br><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.author</span><span class="selector-class">.drop</span>()</span><br></pre></td></tr></tbody></table></figure><br><br>来将其删除。这时候你再执行<code>show collections</code>，就再也看不到我们的author了。<br><br>这一节要记住的点主要只有一个：集合(collection)类似于SQL的表格(table)，类似于Excel的一个个表格。<br><br><h4>5. 插入</h4>

<p>想象一个精简版的“豆瓣电影”。我们需要创建一个数据库，来存储每部电影的信息，电影的信息包括：</p>
<ul><br><li>电影名字</li><br><li>导演</li><br><li>主演(可能多个)</li><br><li>类型标签(可能多个)</li><br><li>上映日期</li><br><li>喜欢人数</li><br><li>不喜欢人数</li><br><li>用户评论(可能多个)</li><br></ul>

<p>显然我们需要先创建一个叫电影的集合：</p>
<figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.createCollection</span>(<span class="string">'movie'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>然后，我们就可以插入数据了：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.insert</span>(</span><br><span class="line"> {</span><br><span class="line">   <span class="attribute">title</span>: <span class="string">'Forrest Gump'</span>,</span><br><span class="line">   directed_by: <span class="string">'Robert Zemeckis'</span>,</span><br><span class="line">   stars: [<span class="string">'Tom Hanks'</span>, <span class="string">'Robin Wright'</span>, <span class="string">'Gary Sinise'</span>],</span><br><span class="line">   tags: [<span class="string">'drama'</span>, <span class="string">'romance'</span>],</span><br><span class="line">   debut: new <span class="built_in">Date</span>(1994,7,6,0,0),</span><br><span class="line">   likes: <span class="number">864367</span>,</span><br><span class="line">   dislikes: <span class="number">30127</span>,</span><br><span class="line">   comments: [</span><br><span class="line">      {</span><br><span class="line">         user:<span class="string">'user1'</span>,</span><br><span class="line">         message: <span class="string">'My first comment'</span>,</span><br><span class="line">         dateCreated: new <span class="built_in">Date</span>(2013,11,10,2,35),</span><br><span class="line">         like: <span class="number">0</span></span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user2'</span>,</span><br><span class="line">         message: <span class="string">'My first comment too!'</span>,</span><br><span class="line">         dateCreated: new <span class="built_in">Date</span>(2013,11,11,6,20),</span><br><span class="line">         like: <span class="number">0</span></span><br><span class="line">      }</span><br><span class="line">   ]</span><br><span class="line">}</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>请注意，这里插入数据之前，我们并不需要先声明movie这个集合里面有哪些项目。我们直接插入就可以了~这一点和SQL不一样，SQL必须先声明一个table里面有哪些列，而MongoDB不需要。</p>
<p>把上面的例子复制进命令行应该可以顺利运行，但我强烈建议你手动打一下，或者输入一部你自己喜欢的电影。<code>insert</code>操作有几点需要注意：</p>
<ul><br><li>1. 不同key-value需要用逗号隔开，而key:value中间是用冒号；</li><br><li>2. 如果一个key有多个value，value要用[]。哪怕当前只有一个value，也加上[]以备后续的添加；</li><br><li>3. 整个“数据块”要用{}括起来；</li><br></ul>

<p>如果你在<code>insert</code>之后看到<code>WriteResult({ "nInserted" : 1 })</code>，说明写入成功。</p>
<p>这个时候你可以用查询的方式来返回数据库中的数据：<br></p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>()<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这里<code>find()</code>里面是空的，说明我们不做限制和筛选，类似于SQL没有<code>WHERE</code>语句一样。而<code>pretty()</code>输出的是经格式美化后的数据，你可以自己试试没有<code>pretty()</code>会怎么样。</p>
<p>仔细观察<code>find()</code>的结果，你会发现多了一个叫<code>'_id'</code>的东西，这是数据库自动创建的一个ID号，在同一个数据库里，每个文档的ID号都是不同的。</p>
<p>我们也可以同时输入多个数据：<br></p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.insert</span>([</span><br><span class="line"> {</span><br><span class="line">   <span class="attribute">title</span>: <span class="string">'Fight Club'</span>,</span><br><span class="line">   <span class="attribute">directed_by</span>: <span class="string">'David Fincher'</span>,</span><br><span class="line">   <span class="attribute">stars</span>: [<span class="string">'Brad Pitt'</span>, <span class="string">'Edward Norton'</span>, <span class="string">'Helena Bonham Carter'</span>],</span><br><span class="line">   <span class="attribute">tags</span>: <span class="string">'drama'</span>,</span><br><span class="line">   <span class="attribute">debut</span>: new Date(<span class="number">1999</span>,<span class="number">10</span>,<span class="number">15</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">   <span class="attribute">likes</span>: <span class="number">224360</span>,</span><br><span class="line">   <span class="attribute">dislikes</span>: <span class="number">40127</span>,</span><br><span class="line">   <span class="attribute">comments</span>: [</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user3'</span>,</span><br><span class="line">         <span class="attribute">message</span>: <span class="string">'My first comment'</span>,</span><br><span class="line">         <span class="attribute">dateCreated</span>: new Date(<span class="number">2008</span>,<span class="number">09</span>,<span class="number">13</span>,<span class="number">2</span>,<span class="number">35</span>),</span><br><span class="line">         <span class="attribute">like</span>: <span class="number">0</span></span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user2'</span>,</span><br><span class="line">         <span class="attribute">message</span>: <span class="string">'My first comment too!'</span>,</span><br><span class="line">         <span class="attribute">dateCreated</span>: new Date(<span class="number">2003</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">6</span>,<span class="number">20</span>),</span><br><span class="line">         <span class="attribute">like</span>: <span class="number">14</span></span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user7'</span>,</span><br><span class="line">         <span class="attribute">message</span>: <span class="string">'Good Movie!'</span>,</span><br><span class="line">         <span class="attribute">dateCreated</span>: new Date(<span class="number">2009</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">6</span>,<span class="number">20</span>),</span><br><span class="line">         <span class="attribute">like</span>: <span class="number">2</span></span><br><span class="line">      }</span><br><span class="line">   ]</span><br><span class="line">},</span><br><span class="line">{</span><br><span class="line">   <span class="attribute">title</span>: <span class="string">'Seven'</span>,</span><br><span class="line">   <span class="attribute">directed_by</span>: <span class="string">'David Fincher'</span>,</span><br><span class="line">   <span class="attribute">stars</span>: [<span class="string">'Morgan Freeman'</span>, <span class="string">'Brad Pitt'</span>,  <span class="string">'Kevin Spacey'</span>],</span><br><span class="line">   <span class="attribute">tags</span>: [<span class="string">'drama'</span>,<span class="string">'mystery'</span>,<span class="string">'thiller'</span>],</span><br><span class="line">   <span class="attribute">debut</span>: new Date(<span class="number">1995</span>,<span class="number">9</span>,<span class="number">22</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">   <span class="attribute">likes</span>: <span class="number">134370</span>,</span><br><span class="line">   <span class="attribute">dislikes</span>: <span class="number">1037</span>,</span><br><span class="line">   <span class="attribute">comments</span>: [</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user3'</span>,</span><br><span class="line">         <span class="attribute">message</span>: <span class="string">'Love Kevin Spacey'</span>,</span><br><span class="line">         <span class="attribute">dateCreated</span>: new Date(<span class="number">2002</span>,<span class="number">09</span>,<span class="number">13</span>,<span class="number">2</span>,<span class="number">35</span>),</span><br><span class="line">         <span class="attribute">like</span>: <span class="number">0</span></span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user2'</span>,</span><br><span class="line">         <span class="attribute">message</span>: <span class="string">'Good works!'</span>,</span><br><span class="line">         <span class="attribute">dateCreated</span>: new Date(<span class="number">2013</span>,<span class="number">10</span>,<span class="number">21</span>,<span class="number">6</span>,<span class="number">20</span>),</span><br><span class="line">         <span class="attribute">like</span>: <span class="number">14</span></span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">         <span class="attribute">user</span>:<span class="string">'user7'</span>,</span><br><span class="line">         <span class="attribute">message</span>: <span class="string">'Good Movie!'</span>,</span><br><span class="line">         <span class="attribute">dateCreated</span>: new Date(<span class="number">2009</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">6</span>,<span class="number">20</span>),</span><br><span class="line">         <span class="attribute">like</span>: <span class="number">2</span></span><br><span class="line">      }</span><br><span class="line">   ]</span><br><span class="line">}</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>顺利的话会显示：<br></p><figure class="highlight ada"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BulkWriteResult({</span><br><span class="line">	<span class="string">"writeErrors"</span> : [ ],</span><br><span class="line">	<span class="string">"writeConcernErrors"</span> : [ ],</span><br><span class="line">	<span class="string">"nInserted"</span> : 2,</span><br><span class="line">	<span class="string">"nUpserted"</span> : 0,</span><br><span class="line">	<span class="string">"nMatched"</span> : 0,</span><br><span class="line">	<span class="string">"nModified"</span> : 0,</span><br><span class="line">	<span class="string">"nRemoved"</span> : 0,</span><br><span class="line">	<span class="string">"upserted"</span> : [ ]</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>表面我们成功地插入了两个数据。注意批量插入的格式是这样的：<code>db.movie.insert([{ITEM1},{ITEM2}])</code>。几部电影的外面需要用[]括起来。</p>
<p>请注意，虽然collection的插入不需要先声明，但表达相同意思的key，名字要一样，比如，如果我们在一个文档里用<code>directed_by</code>来表示导演，则在其它文档也要保持同样的名字(而不是<code>director</code>之类的)。不同的名字不是不可以，技术上完全可行，但会给查询和更新带来困难。</p>
<p>好了，到这里，我们就有了一个叫tutorial的数据库，里面有一个叫movie的集合，而movie里面有三个记录。接下来我们就可以对其进行查询了。</p>
<h4>6. 查询</h4>

<p>在上一节我们已经接触到最简单的查询<code>db.movie.find().pretty()</code>。MongoDB支持各种各样的深度查询功能。先来一个最简单的例子，找出大卫芬奇(David Fincher)导演的所有电影：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="string">'directed_by'</span>:<span class="string">'David Fincher'</span>}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<p>将返回《搏击俱乐部》和《七宗罪》两部电影。这种搜索和SQL的<code>WHERE</code>语句是很相似的。</p>
<p>也可以设置多个条件。比如找出大卫芬奇导演的, 摩根弗里曼主演的电影：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="string">'directed_by'</span>:<span class="string">'David Fincher'</span>, <span class="string">'stars'</span>:<span class="string">'Morgan Freeman'</span>}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<p>这里两个条件之间，是AND的关系，只有同时满足两个条件的电影才会被输出。同理，可以设置多个的条件，不赘述。</p>
<p>条件之间也可以是或的关系，比如找出罗宾怀特或摩根弗里曼主演的电影：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>(</span><br><span class="line">{</span><br><span class="line">  <span class="variable">$or</span>:</span><br><span class="line">     [  {<span class="string">'stars'</span>:<span class="string">'Robin Wright'</span>},</span><br><span class="line">        {<span class="string">'stars'</span>:<span class="string">'Morgan Freeman'</span>}</span><br><span class="line">     ]</span><br><span class="line">}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<p>注意这里面稍显复杂的各种括号。</p>
<p>还可以设置一个范围的搜索，比如找出50万人以上赞的电影：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="string">'likes'</span>:{<span class="variable">$gt</span>:<span class="number">500000</span>}}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<p>同样要注意略复杂的括号。注意，在这些查询里，key的单引号都是可选的，也就是说，上述语句也可以写成：<br></p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="attribute">likes</span>:{$gt:<span class="number">500000</span>}})<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>类似地，少于二十万人赞的电影：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="attribute">likes</span>:{$lt:<span class="number">200000</span>}})<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>类似的运算符还有：<code>$let</code>:小于或等于；<code>$get</code>:大于或等于；<code>$ne</code>:不等于。</p>
<p>注意，对于包含多个值的key，同样可以用find来查询。比如：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="string">'tags'</span>:<span class="string">'romance'</span>})</span><br></pre></td></tr></tbody></table></figure>
<p>将返回《阿甘正传》，虽然其标签既有romance，又有drama，但只要符合一个就可以了。</p>
<p>如果你确切地知道返回的结果只有一个，也可以用<code>findOne</code>:</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.findOne</span>({<span class="string">'title'</span>:<span class="string">'Forrest Gump'</span>})</span><br></pre></td></tr></tbody></table></figure>
<p>如果有多个结果，则会按磁盘存储顺序返回第一个。请注意，<code>findOne()</code>自带pretty模式，所以不能再加<code>pretty()</code>，将报错。</p>
<p>如果结果很多而你只想显示其中一部分，可以用<code>limit()</code>和<code>skip()</code>，前者指明输出的个数，后者指明从第二个结果开始数。比如：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>()<span class="selector-class">.limit</span>(2)<span class="selector-class">.skip</span>(1)<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>则跳过第一部，从第二部开始选取两部电影。</p>
<h4>7. 局部查询</h4>

<p>第五节的时候我们讲了<code>find</code>的用法，但对于符合条件的条目，我们都是返回整个JSON文件的。这类似于SQL里面的<code>SELECT *</code>。有的时候，我们需要的，仅仅是部分数据，这个时候，<code>find</code>的局部查询的功能就派上用场了。先来看一个例子，返回tags为drama的电影的名字和首映日期。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="string">'tags'</span>:<span class="string">'drama'</span>},{<span class="string">'debut'</span>:<span class="number">1</span>,<span class="string">'title'</span>:<span class="number">1</span>}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<p>数据库将返回：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">	<span class="attr">"_id"</span> : ObjectId(<span class="string">"549cfb42f685c085f1dd47d4"</span>),</span><br><span class="line">	<span class="attr">"title"</span> : <span class="string">"Forrest Gump"</span>,</span><br><span class="line">	<span class="attr">"debut"</span> : ISODate(<span class="string">"1994-08-05T16:00:00Z"</span>)</span><br><span class="line">}</span><br><span class="line">{</span><br><span class="line">	<span class="attr">"_id"</span> : ObjectId(<span class="string">"549cff96f685c085f1dd47d6"</span>),</span><br><span class="line">	<span class="attr">"title"</span> : <span class="string">"Fight Club"</span>,</span><br><span class="line">	<span class="attr">"debut"</span> : ISODate(<span class="string">"1999-11-14T16:00:00Z"</span>)</span><br><span class="line">}</span><br><span class="line">{</span><br><span class="line">	<span class="attr">"_id"</span> : ObjectId(<span class="string">"549cff96f685c085f1dd47d7"</span>),</span><br><span class="line">	<span class="attr">"title"</span> : <span class="string">"Seven"</span>,</span><br><span class="line">	<span class="attr">"debut"</span> : ISODate(<span class="string">"1995-10-21T16:00:00Z"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这里find的第二个参数是用来控制输出的，1表示要返回，而0则表示不返回。默认值是0，但<code>_id</code>是例外，因此如果你不想输出<code>_id</code>，需要显式地声明：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="string">'tags'</span>:<span class="string">'drama'</span>},{<span class="string">'debut'</span>:<span class="number">1</span>,<span class="string">'title'</span>:<span class="number">1</span>,<span class="string">'_id'</span>:<span class="number">0</span>}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<h4>8. 更新</h4><br>很多情况下你需要更新你的数据库，比如有人对某部电影点了个赞，那么你需要更新相应的数据库。比如有人对《七宗罪》点了个赞，而它本来的赞的个数是134370，那么你需要更新到134371。可以这样操作：<br><br><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.update</span>({<span class="attribute">title</span>:<span class="string">'Seven'</span>}, {$<span class="attribute">set</span>:{<span class="attribute">likes</span>:<span class="number">134371</span>}})</span><br></pre></td></tr></tbody></table></figure><br><br>第一个大括号里表明要选取的对象，第二个表明要改动的数据。请注意上述的操作相当不现实，因为你首先要知道之前的数字是多少，然后加一，但通常你不读取数据库的话，是不会知道这个数(134370)的。MongoDB提供了一种简便的方法，可以对现有条目进行增量操作。假设又有人对《七宗罪》点了两个赞，则可以：<br><br><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.update</span>({<span class="attribute">title</span>:<span class="string">'Seven'</span>}, {$<span class="attribute">inc</span>:{<span class="attribute">likes</span>:<span class="number">2</span>}})</span><br></pre></td></tr></tbody></table></figure><br><br>如果你查询的话，会发现点赞数变为134373了，这里用的是<code>$inc</code>。除了增量更新，MongoDB还提供了很多灵活的更新选项，具体可以看：<a href="http://docs.mongodb.org/manual/reference/operator/update-field/" target="_blank" rel="noopener">http://docs.mongodb.org/manual/reference/operator/update-field/</a> 。<br><br>注意如果有多部符合要求的电影。则默认只会更新第一个。如果要多个同时更新，要设置<code>{multi:true}</code>，像下面这样：<br><figure class="highlight xquery"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.movie.<span class="keyword">update</span>({}, {$inc:{likes:<span class="number">10</span>}},{multi:true})</span><br></pre></td></tr></tbody></table></figure><br><br>所有电影的赞数都多了10.<br><br>注意，以上的更新操作会替换掉原来的值，所以如果你是想在原有的值得基础上增加一个值的话，则应该用<code>$push</code>，比如，为《七宗罪》添加一个popular的tags。<br><br><figure class="highlight xquery"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.movie.<span class="keyword">update</span>({<span class="string">'title'</span>:<span class="string">'Seven'</span>}, {$push:{<span class="string">'tags'</span>:<span class="string">'popular'</span>}})</span><br></pre></td></tr></tbody></table></figure><br><br>你会发现《七宗罪》现在有四个标签：<br><br><figure class="highlight ada"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line">	<span class="string">"drama"</span>,</span><br><span class="line">	<span class="string">"mystery"</span>,</span><br><span class="line">	<span class="string">"thiller"</span>,</span><br><span class="line">	<span class="string">"popular"</span></span><br><span class="line">],</span><br></pre></td></tr></tbody></table></figure><br><br><h4>9. 删除</h4>

<p>删除的句法和find很相似，比如，要删除标签为romance的电影，则：<br></p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.remove</span>({<span class="string">'tags'</span>:<span class="string">'romance'</span>})</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>考虑到我们数据库条目异常稀少，就不建议你执行这条命令了~</p>
<p>注意，上面的例子会删除所有标签包含romance的电影。如果你只想删除第一个，则<br></p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.remove</span>({<span class="string">'tags'</span>:<span class="string">'romance'</span>},<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>如果不加任何限制：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.remove</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>会删除movie这个集合下的所有文档。</p>
<h4>10. 索引和排序</h4>

<p>为文档中的一些key加上索引(index)可以加快搜索速度。这一点不难理解，假如没有没有索引，我们要查找名字为Seven的电影，就必须在所有文档里逐个搜索。而如果对名字这个key加上索引值，则电影名这个字符串和数字建立了映射，这样在搜索的时候就会快很多。排序的时候也是如此，不赘述。MongoDB里面为某个key加上索引的方式很简单，比如我们要对导演这个key加索引，则可以：<br></p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.ensureIndex</span>({<span class="attribute">directed_by</span>:<span class="number">1</span>})</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这里的1是升序索引，如果要降序索引，用-1。</p>
<p>MongoDB支持对输出进行排序，比如按名字排序：<br></p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>().sort({<span class="string">'title'</span>:<span class="number">1</span>}).pretty()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>同样地，1是升序，-1是降序。默认是1。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.getIndexes</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>将返回所有索引，包括其名字。</p>
<p>而</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.dropIndex</span>(<span class="string">'index_name'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>将删除对应的索引。</p>
<h4>11. 聚合</h4>

<p>MongoDB支持类似于SQL里面的<code>GROUP BY</code>操作。比如当有一张学生成绩的明细表时，我们可以找出每个分数段的学生各有多少。为了实现这个操作，我们需要稍加改动我们的数据库。执行以下三条命令：</p>
<figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.update</span>({<span class="attribute">title</span>:<span class="string">'Seven'</span>},{$<span class="attribute">set</span>:{<span class="attribute">grade</span>:<span class="number">1</span>}})</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.update</span>({<span class="attribute">title</span>:<span class="string">'Forrest Gump'</span>},{$<span class="attribute">set</span>:{<span class="attribute">grade</span>:<span class="number">1</span>}})</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.update</span>({<span class="attribute">title</span>:<span class="string">'Fight Club'</span>},{$<span class="attribute">set</span>:{<span class="attribute">grade</span>:<span class="number">2</span>}})</span><br></pre></td></tr></tbody></table></figure>
<p>这几条是给每部电影加一个虚拟的分级，前两部是归类是一级，后一部是二级。</p>
<p>这里你也可以看到MongoDB的强大之处：可以动态地后续添加各种新项目。</p>
<p>我们先通过聚合来找出总共有几种级别。</p>
<figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.aggregate</span>([{$<span class="attribute">group</span>:{<span class="attribute">_id</span>:<span class="string">'$grade'</span>}}])</span><br></pre></td></tr></tbody></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="attr">"_id"</span> : <span class="number">2</span> }</span><br><span class="line">{ <span class="attr">"_id"</span> : <span class="number">1</span> }</span><br></pre></td></tr></tbody></table></figure>
<p>注意这里的2和1是指级别，而不是每个级别的电影数。这个例子看得清楚些：</p>
<figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.aggregate</span>([{$<span class="attribute">group</span>:{<span class="attribute">_id</span>:<span class="string">'$directed_by'</span>}}])</span><br></pre></td></tr></tbody></table></figure>
<p>这里按照导演名字进行聚合。输出：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="attr">"_id"</span> : <span class="string">"David Fincher"</span> }</span><br><span class="line">{ <span class="attr">"_id"</span> : <span class="string">"Robert Zemeckis"</span> }</span><br></pre></td></tr></tbody></table></figure>
<p>接着我们要找出，每个导演的电影数分别有多少：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.aggregate</span>([{<span class="variable">$group</span>:{_id:<span class="string">'$directed_by'</span>,num_movie:{<span class="variable">$sum</span>:<span class="number">1</span>}}}])</span><br></pre></td></tr></tbody></table></figure>
<p>将会输出：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="attr">"_id"</span> : <span class="string">"David Fincher"</span>, <span class="attr">"num_movie"</span> : <span class="number">2</span> }</span><br><span class="line">{ <span class="attr">"_id"</span> : <span class="string">"Robert Zemeckis"</span>, <span class="attr">"num_movie"</span> : <span class="number">1</span> }</span><br></pre></td></tr></tbody></table></figure>
<p>注意$sum后面的1表示只是把电影数加起来，但我们也可以统计别的数据，比如两位导演谁的赞比较多：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.aggregate</span>([{<span class="variable">$group</span>:{_id:<span class="string">'$directed_by'</span>,num_likes:{<span class="variable">$sum</span>:<span class="string">'$likes'</span>}}}])</span><br></pre></td></tr></tbody></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="attr">"_id"</span> : <span class="string">"David Fincher"</span>, <span class="attr">"num_likes"</span> : <span class="number">358753</span> }</span><br><span class="line">{ <span class="attr">"_id"</span> : <span class="string">"Robert Zemeckis"</span>, <span class="attr">"num_likes"</span> : <span class="number">864377</span> }</span><br></pre></td></tr></tbody></table></figure>
<p>注意这些数据都纯属虚构啊！</p>
<p>除了<code>$sum</code>，还有其它一些操作。比如：<br></p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.aggregate</span>([{<span class="variable">$group</span>:{_id:<span class="string">'$directed_by'</span>,num_movie:{<span class="variable">$avg</span>:<span class="string">'$likes'</span>}}}])</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>统计平均的赞。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.aggregate</span>([{<span class="variable">$group</span>:{_id:<span class="string">'$directed_by'</span>,num_movie:{<span class="variable">$first</span>:<span class="string">'$likes'</span>}}}]</span><br></pre></td></tr></tbody></table></figure>
<p>返回每个导演的电影中的第一部的赞数。</p>
<p>其它各种操作可以参考：<a href="http://docs.mongodb.org/manual/reference/operator/aggregation/group/" target="_blank" rel="noopener">http://docs.mongodb.org/manual/reference/operator/aggregation/group/</a> 。</p>
<h4>12. All or Nothing?</h4>

<p>MongoDB支持单个文档内的原子化操作(atomic operation)，这是说，可以将多条关于同一个文档的指令放到一起，他们要么一起执行，要么都不执行。而不会执行到一半。有些场合需要确保多条执行一起顺次执行。比如一个场景：一个电商网站，用户查询某种商品的剩余数量，以及用户购买该种商品，这两个操作，必须放在一起执行。不然的话，假定我们先执行剩余数量的查询，这是假定为1，用户接着购买，但假如这两个操作之间还加入了其它操作，比如另一个用户抢先购买了，那么原先购买用户的购买的行为就会造成数据库的错误，因为实际上这种商品以及没有存货了。但因为查询剩余数量和购买不是在一个“原子化操作”之内，因此会发生这样的错误<a href="http://www.tutorialspoint.com/mongodb/mongodb_atomic_operations.htm" target="_blank" rel="noopener">[2]</a>。</p>
<p>MongoDB提供了<code>findAndModify</code>的方法来确保atomic operation。比如这样的：<br></p><figure class="highlight xquery"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.movie.findAndModify(</span><br><span class="line">			{</span><br><span class="line">			query:{<span class="string">'title'</span>:<span class="string">'Forrest Gump'</span>},</span><br><span class="line">			update:{$inc:{likes:<span class="number">10</span>}}</span><br><span class="line">			}</span><br><span class="line">		      )</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>query是查找出匹配的文档，和find是一样的，而update则是更新likes这个项目。注意由于MongoDB只支持单个文档的atomic operation，因此如果query出多于一个文档，则只会对第一个文档进行操作。</p>
<p><code>findAndModify</code>还支持更多的操作，具体见：<a href="http://docs.mongodb.org/manual/reference/command/findAndModify/。" target="_blank" rel="noopener">http://docs.mongodb.org/manual/reference/command/findAndModify/。</a></p>
<h4>13. 文本搜索</h4>

<p>除了前面介绍的各种深度查询功能，MongoDB还支持文本搜索。对文本搜索之前，我们需要先对要搜索的key建立一个text索引。假定我们要对标题进行文本搜索，我们可以先这样：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.ensureIndex</span>({<span class="attribute">title</span>:<span class="string">'text'</span>})</span><br></pre></td></tr></tbody></table></figure>
<p>接着我们就可以对标题进行文本搜索了，比如，查找带有”Gump”的标题：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="variable">$text</span>:{<span class="variable">$search</span>:<span class="string">"Gump"</span>}}).pretty()</span><br></pre></td></tr></tbody></table></figure>
<p>注意text和search前面的$符号。</p>
<p>这个例子里，文本搜索作用不是非常明显。但假设我们要搜索的key是一个长长的文档，这种text search的方便性就显现出来了。MongoDB目前支持15种语言的文本搜索。</p>
<h4>14. 正则表达式</h4>

<p>MongoDB还支持基于正则表达式的查询。如果不知道正则表达式是什么，可以参考<a href="http://en.wikipedia.org/wiki/Regular_expression" target="_blank" rel="noopener">Wikipedia</a>。这里简单举几个例子。比如，查找标题以<code>b</code>结尾的电影信息：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="attribute">title</span>:{$regex:<span class="string">'.*b$'</span>}})<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>也可以写成：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="attribute">title</span>:/.*b$/})<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>查找含有’Fight’标题的电影：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="attribute">title</span>:/Fight/})<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>注意以上匹配都是区分大小写的，如果你要让其不区分大小写，则可以：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.movie</span><span class="selector-class">.find</span>({<span class="attribute">title</span>:{$regex:<span class="string">'fight.*b'</span>,$options:<span class="string">'$i'</span>}})<span class="selector-class">.pretty</span>()</span><br></pre></td></tr></tbody></table></figure>
<p><code>$i</code>是insensitive的意思。这样的话，即使是小写的fight，也能搜到了。</p>
<h4>15. 后记</h4>

<p>至此，MongoDB的最基本的内容就介绍得差不多了。如果有什么遗漏的以后我会补上來。如果你一路看到底完全了这个入门教程，恭喜你，你一定是一个有毅力的人。</p>
<p>把这个文档过一遍，不会让你变成一个MongoDB的专家(如果会那就太奇怪了)。但如果它能或多或少减少你上手的时间，或者让你意识到“咦，MongoDB其实没那么复杂”，那么这个教程的目的也就达到啦。</p>
<p>这个文档是匆忙写就的，出错简直是一定的。如果您发现了任何错误或者有关于本文的任何建议，麻烦发邮件给我（stevenslxie at gmail.com）或者在GitHub上直接交流，不胜感激。</p>
<p></p><h4>转载声明</h4><br>如果你喜欢这篇文章，可以随意转载。但请<p></p>
<ul><br><li>标明原作者StevenSLXie;</li><br><li>标明原链接(<a href="https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md)" target="_blank" rel="noopener">https://github.com/StevenSLXie/Tutorials-for-Web-Developers/blob/master/MongoDB%20%E6%9E%81%E7%AE%80%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8.md)</a>;</li><br><li>在可能的情况下请保持文本显示的美观。比如，请不要直接一键复制到博客之类，因为代码的显示效果可能非常糟糕;</li><br><li>请将这个转载声明包含进来；</li><br></ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mongodb/" rel="tag"># mongodb</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/46563/" rel="next" title="正则表达式">
                <i class="fa fa-chevron-left"></i> 正则表达式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/61797/" rel="prev" title="python中多进程和多线程的使用">
                python中多进程和多线程的使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">King sea</p>
              <p class="site-description motion-element" itemprop="description">NLPER|Dialogue System</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">1. 为什么用MongoDB？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">2. 关于这篇文章</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">3. 安装与环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">4. 创建集合和删除集合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">5. 插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">6. 查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">7. 局部查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">8. 更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">9. 删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">10.</span> <span class="nav-text">10. 索引和排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">11.</span> <span class="nav-text">11. 聚合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">12.</span> <span class="nav-text">12. All or Nothing?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">13.</span> <span class="nav-text">13. 文本搜索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">14.</span> <span class="nav-text">14. 正则表达式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">15.</span> <span class="nav-text">15. 后记</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">16.</span> <span class="nav-text">转载声明</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">© <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">King sea</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 — <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  



</body></html>